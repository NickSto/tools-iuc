<?xml version="1.0" encoding="UTF-8"?>
<tool id="hd" name="HD:" version="1.0.0">
    <description>hamming distance analysis of duplex tags</description>
    <macros>
        <import>fsd_macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="2.7">python</requirement>
        <requirement type="package" version="1.4.0">matplotlib</requirement>
    </requirements>
    <command><![CDATA[
        python2 '$__tool_directory__/hd.py' 
        --inputFile '${inputFile}' 
        --inputName1 '${inputFile.name}' 

        --sample_size '${sampleSize}'
        --subset_tag '${subsetTag}'
        --nproc "\${GALAXY_SLOTS:-1}" 
        $onlyDCS 
        --minFS '${minFS}' 
        --maxFS '${maxFS}'
		$nr_above_bars 
        --output_pdf '${output_pdf}'
        --output_tabular '${output_tabular}'
    ]]>
    </command>
    <inputs>
        <param name="inputFile" type="data" format="tabular" label="Input tags" optional="false" help="This dataset is generated by port-processing of the output from 'Make Families' tool. See Help section below for an explanation."/>
        <!-- <param name="inputFile2" type="data" format="tabular" label="Dataset 2: input tags" optional="true" help="Input in tabular format with the family size, tag and the direction of the strand ('ab' or 'ba') for each family."/> -->
        <param name="sampleSize" type="integer" label="Number of tags to sample" value="1000" min="0" help="A typical duplex experiment contains very large number of tags. To reduce the runtime of this tool it can sample a subset of tags from the dataset. This parameter specifies how many tags to sample. 1000 is a good starting default. Set to '0' to sample all tags."/>
        <param name="minFS" type="integer" label="Minimum family size" min="1" value="1" help="Tags forming families of size smaller than this value will be filtered out. Default = 1"/>
        <param name="maxFS" type="integer" label="Maximum family size" min="0" value="0" help="Tags forming families of size larger than this value will be filtered out. Set to '0' to turn off this restriction. Default = 0"/>
        <param name="onlyDCS" type="boolean" label="Include only DCS in the analysis?" truevalue="" falsevalue="--only_DCS" checked="False" help="Include only tags forming duplex families (e.g., present in ab and ba configurations)."/>
        <param name="subsetTag" type="integer" label="Shorten tag in the analysis?" value="0" help="Use this parameter to simulate shorted tag lengths. Set to '0' to keep the original length. Default = 0"/>
        <param name="nr_above_bars" type="boolean" label="Include numbers above bars?" truevalue="--nr_above_bars" falsevalue="" checked="True" help="The absolute and relative values of the data can be included or removed from the plots. "/>
 
    </inputs>
    <outputs>
        <data name="output_tabular" format="tabular" label="${tool.name} on ${on_string}: Summary"/>
        <!-- <data name="output_tabular2" format="tabular">
            <filter>inputFile2</filter>
        </data> -->
        <data name="output_pdf" format="pdf" label="${tool.name} on ${on_string}: PDF" />
        <!-- <data name="output_pdf2" format="pdf" >
            <filter>inputFile2</filter>
        </data> -->
    </outputs>
    <tests>
        <test>
            <param name="inputFile" value="hd_data1.tab"/>
           <!-- <param name="inputFile2" value="hd_data2.tab"/> -->
            <param name="sampleSize" value="0"/>
            <output name="output_pdf" file="hd_output1.pdf" lines_diff="136" />
            <output name="output_tabular" file="hd_output1.tab"/>
          <!--  <output name="output_pdf2" file="hd_output2.pdf" lines_diff="6"/>
            <output name="output_tabular2" file="hd_output2.tab"/> -->
        </test>
    </tests>
    <help> <![CDATA[
**What it does**

Tags used in Duplex Sequencing (DS) are randomized 12-mers. Since each DNA fragment is labeled by two tags at each end there are theoretically 4 to the power of (12+12) unique combinations. However, the input DNA in a typical DS experiment contains only ~1,000,000 molecules creating a large tag-to-input excess (4^24 â‰« 1,000,000). Because of such excess it is, theoretically, highly unlikely to observe distinct input DNA molecules tagged by barcodes that are highly similar to each other.  

This tool allows to see if there are tags highly similar to each other. It uses `Hamming distance <https://en.wikipedia.org/wiki/Hamming_distance>`_ as a measure of similarity. In this context the Hamming distane is simply the number of differences between two tags. 
    
**Input**
    
This tools expects a tabular file with the tags of all families, their sizes and information about forward (ab) and reverse (ba) strands::

  1  AAAAAAAAAAAATGTTGGAATCTT ba
 10  AAAAAAAAAAAGGCGGTCCACCCC ab
 28  AAAAAAAAAAATGGTATGGACCGA ab

.. class:: infomark

**How to generate the input**

The first step of the `Du Novo Analysis Pipeline <https://doi.org/10.1186/s13059-016-1039-4>`_ is the **Make Families** tool that produces output in this form::

 1                        2  3     4
 ------------------------------------------------------
 AAAAAAAAAAAAAAATAGCTCGAT ba read1 CGCTACGTGACTGGGTCATG
 AAAAAAAAAAAAAAATAGCTCGAT ba read2 CGCTACGTGACTGGGTCATG
 AAAAAAAAAAAAAAATAGCTCGAT ba read3 CGCTACGTGACTGGGTCATG

we only need columns 1 and 2. These two columns can be extracted from this dataset using **Cut** tool::

 1                        2 
 ---------------------------
 AAAAAAAAAAAAAAATAGCTCGAT ba
 AAAAAAAAAAAAAAATAGCTCGAT ba
 AAAAAAAAAAAAAAATAGCTCGAT ba

now one needs to count the number of unique occurencies of each tag. This is done using **Unique lines** tool, which would add an additional column containg counts (column 1)::


 1 2                        3 
 -----------------------------
 3 AAAAAAAAAAAAAAATAGCTCGAT ba
 
these data can now be used in this tool.
    
**Output**
    
The output is one PDF file with the plots of the Hamming distance and a tabular file with the data of the plot for each dataset. It contains several panles.

 1. This first page contains grapth representing hamming distance by family size.
 2. The second page contains that is plotted differently: the X axis is the family size instead of the Hamming distance. 
 3. 
    
@author@
    
   ]]> 
    
   </help>
    <expand macro="@citation@" />
</tool>

